<% provide(:title, @object.name ) %>
<% provide(:header, ((link_to image_tag(set_rarity_image(@set.code, @object.rarity)), magic_set_path(@set.code)) + " " + @object.name + " " + (@object.foil ? image_tag("foil.png", height: "30px", title: "Foil") : "")).html_safe ) %>
<div class="container">
  <div class="row">
    <div class="col-xs-12 inverse">
            <%= card_image(@object) %>
            <br>
            <strong>MTGO ID</strong>: <%= @object.mtgo_id %><br>
            <%= "<strong>Collector #</strong>:  #{@object.collector_number}".html_safe if @object.collector_number.present? %>
    </div>
  </div>
  <% if @user.present? %>
    <div class="row">
      <div class="col-xs-6">
        <%= form_tag transaction_path, method: :post, id: "form-transaction" do %>
          <div class="panel panel-default">
            <div class="panel-body">
              <div class="form-group">
                <%= label_tag 'price', "Price", class: "control-label" %>
                <%= number_field_tag 'price', nil, min: 0.01, max: 999.9, step: 0.001, class: "form-control" %>        
              </div>
              <div class="form-group">
                <%= label_tag 'quantity', "Quantity", class: "control-label" %>
                <%= number_field_tag 'quantity', 1, min: 1, max: 999, class: "form-control" %>        
              </div>
              <small id="insufficient-tickets" style="display: none; color: #a94442;">
                You do not have enough tickets for this purchase.
              <br>
              </small>
              <small id="insufficient-cards" style="display: none; color: #a94442;">
                You do not have that many copies deposited. 
              <br>
              </small>
            </div>
            <div class="panel-footer">
              <%= submit_tag "Buy", class: "btn btn-primary", id: "submit-buy" %>
              <%= submit_tag "Sell", class: "btn btn-primary", id: "submit-sell" %>
            </div>
          </div>
        <% end %>
      </div>
      <div class="col-xs-6">
        <%= form_tag transfer_path, method: :post do %>
          <div class="panel panel-default">
            <div class="panel-body">
              Transfers
              <div class="form-group">
              </div>
              <div class="form-group">
              </div>
            </div>
            <div class="panel-footer">
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <div class="row">
    <div class="col-xs-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          Bids:
        </div>
        <ul class="list-group">
          <% @bids.each do |bid| %>
            <li class="list-group-item">
              $<%= bid.price %>
              <span class="badge"><%= bid.num_bids %></span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
    <div class="col-xs-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          Listings:
        </div>
        <ul class="list-group">
          <% @listings.each do |listing| %>
            <li class="list-group-item">
              $<%= listing.price %>
              <span class="badge"><%= listing.num_listings %></span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
    <div class="col-xs-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          Past Sales:
        </div>
        <ul class="list-group">
          <% @sales.each do |sale| %>
            <li class="list-group-item">
              $<%= sale.price %>
              <span class="badge"><%= sale.num_sales %></span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <h4 class="treamd-24 inverse">All Versions</h4>
      <table class="table table-condensed set-table" id="versions">
        <thead>
          <tr>
            <th>
              Version
            </th>
            <th>
              High Buyer
            </th>
            <th>
              Low Seller
            </th>
            <% if @user.present? %>
              <th>
                <%= image_tag('DD.png', height: "20px", title: "DrawDiscard") %>
              </th>
              <th>
                <%= image_tag('arrowDD.png', height: "20px", title: "Depositing") %>
              </th>
              <th>
                <%= image_tag('arrowM.png', height: "20px", title: "Withdrawing") %>
              </th>
              <th>
                <%= image_tag('M.png', height: "20px", title: "MTGO") %>
              </th>
              <th>
                <%= image_tag('forSale.png', height: "20px", title: "Selling") %>
              </th>
              <th>
                <%= image_tag('bids.png', height: "20px", title: "Buying") %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @versions.each do |card| %>
            <% version_string = card.name+", "+card.magic_set.name+(card.foil ? ", Foil" : "") %>
            <%# version_string = card.name+", "+card.rarity.to_s.titleize+", "+card.magic_set.name+(card.foil ? ", Foil" : "") %>
            <tr>
              <td>
                <%= link_to magic_set_magic_card_path(card.magic_set, card.mtgo_id), title: version_string do %>
                  <%= image_tag(set_rarity_image(card.magic_set.code, card.rarity), height: "50%", alt: version_string) %>
                  <%= (card.foil ? image_tag("foil.png", height: "30%", alt: "Foil") : "") %>
                <% end %>
            <td>
              <%= ( !card.buying_price.nil? ? "$"+card.buying_price.to_s : "" ) %>
            </td>
            <td>
              <%= ( !card.selling_price.nil? ? "$"+card.selling_price.to_s : "" ) %>
            </td>
            <% if @user.present? %>
              <% if card.online > 0 %>
                <td data-search="online">
                  <%= card.online %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
              <% if card.depositing > 0 %>
                <td data-search="depositing">
                  <%= card.depositing %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
              <% if card.withdrawing > 0 %>
                <td data-search="withdrawing">
                  <%= card.withdrawing %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
              <% if card.offline > 0 %>
                <td data-search="offline">
                  <%= card.offline %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
              <% if card.selling > 0 %>
                <td data-search="selling">
                  <%= card.selling %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
              <% if card.buying > 0 %>
                <td data-search="buying">
                  <%= card.buying %> 
                </td>
              <% else %>
                <td data-search='`'></td>
              <% end %> 
            <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <% if @user.present? %>
    <div class="row">
      <div class="col-xs-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            Open Bids:
          </div>
          <ul class="list-group">
            <% @user_bids.each do |bid| %>
              <li class="list-group-item">
                <%= bid.price %>
                <span class="badge"><%= bid.num_bids %></span>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
      <div class="col-xs-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            Open Listings:
          </div>
          <ul class="list-group">
            <% @user_listings.each do |listing| %>
              <li class="list-group-item">
                <%= listing.price %>
                <span class="badge"><%= listing.num_listings %></span>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
$(document).ready(function() {
  $("#price").on('input', function() { 
    if ($("#price").val() < 2 ){ document.getElementById("price").min = "0.01"; }
    else if ($("#price").val() >= 10 ) { document.getElementById("price").min = "0.0"; }
  });
  var mousedown = false;
  $("#price").on('mousedown', function(e) { mousedown = true; });
  $(document).on('mouseup', function(e) { mousedown = false; });
  var before_price = $("#price").val();
  $("#price").on('input', function(e) {
    if (mousedown) {
      if ( (before_price == 2) || (before_price == 10) ) { 
        if ( +before_price < +$("#price").val() ) {
          document.getElementById("price").value = before_price;
          price_increment("up");
          document.getElementById("price").stepUp(1);
        }
        else if ( +before_price > +$("#price").val()) {
          document.getElementById("price").value = before_price;
          price_increment("down");
          document.getElementById("price").stepDown(1);
        }
      }
    }
    before_price = $("#price").val();
    price_increment();
  }); 
  $("#price").on('keydown', function(e) { 
    if (e.which === 38) { price_increment("up"); }
    else if (e.which === 40) { price_increment("down"); }
  });
  $("#price").on('mousewheel', function(e) {
    if (e.originalEvent.wheelDelta > 0) { price_increment("up"); }
    else if (e.originalEvent.wheelDelta < 0) { price_increment("down"); }
  });
  function price_increment(direction) {
    if ($("#price").val() < 2 ){ document.getElementById("price").step = "0.001"; }
    else if ($("#price").val() == 2 ) {
      if (direction === "up") { document.getElementById("price").step = "0.01"; }
      else if (direction === "down") { document.getElementById("price").step = "0.001"; }
    }
    else if ($("#price").val() < 10 ) { document.getElementById("price").step = "0.01"; }
    else if ($("#price").val() == 10 ) {
      if (direction === "up") { document.getElementById("price").step = "0.1"; }
      else if (direction === "down") { document.getElementById("price").step = "0.01"; }
    }
    else if ($("#price").val() > 10 ) { document.getElementById("price").step = "0.1"; }
  }

  $('#form-transaction').bootstrapValidator({
    feedbackIcons: {
      valid: 'glyphicon glyphicon-ok',
      invalid: 'glyphicon glyphicon-remove',
      validating: 'glyphicon glyphicon-refresh'
    },
    fields: {
      price: {
        validators: {
          notEmpty: {
            message: 'The price is required and cannot be empty'
          },
          callback: {
            callback: function (value, validator, $field) {
              value = parseFloat(value);
              if ((value >= .01) && (value <= 2) && (value.toFixed(3) != value) ) {
                return {
                  valid: false,
                  message: 'Prices under 2 tickets must be set in increments of .001'
                }
              }
              else if ((value >= 2) && (value <= 10) && (value.toFixed(2) != value)) {
                return {
                  valid: false,
                  message: 'Prices between 2 and 10 tickets must be set in increments of .01'
                }
              }
              else if ((value >= 10) && (value.toFixed(1) != value) ) {
                return {
                  valid: false,
                  message: 'Prices above 10 tickets must be set in increments of .01'
                }
              }
              else {
                return {
                  valid: true
                }
              }
            }
          }
        }
      },
      quantity: {
        validators: {
          notEmpty: {
            message: 'The quantity is required and cannot be empty'
          },
          integer: {
            message: 'The quantity must be an integer'
          }
        }
      }
    }
  });
  <% if @user.present? %>
    $("#price, #quantity").on("input", function() {
      $('#form-transaction').data('bootstrapValidator').validate();
      if (+$("#quantity").val() > <%= @versions.select {|o| o.id == @object.id}.first.online %>) {
        document.getElementById('submit-sell').disabled = true;
        $('#insufficient-cards').show();
      } else if ($('#form-transaction').data('bootstrapValidator').isValid()) {
        document.getElementById('submit-sell').disabled = false;
        $('#insufficient-cards').hide();
      } else {
        $('#insufficient-cards').hide();
      }
      if ((+$("#quantity").val() * +$('#price').val()) > <%= @user.wallet %>) {
        document.getElementById('submit-buy').disabled = true;
        $('#insufficient-tickets').show();
      } else if ($('#form-transaction').data('bootstrapValidator').isValid()) {
        document.getElementById('submit-buy').disabled = false; 
        $('#insufficient-tickets').hide();
      } else {
        $('#insufficient-tickets').hide();
      }
    });
  <% end %>
});
</script>
